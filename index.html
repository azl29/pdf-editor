
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر PDF شامل - نصوص، صور، وتوقيع يدوي</title>
  <style>
    body { font-family: 'Cairo', sans-serif; text-align: center; direction: rtl; margin: 20px; }
    .controls { margin: 15px 0; }
    input, select, button { padding: 8px; margin: 5px; }
    canvas { border: 1px solid #ccc; }
    .page-container { position: relative; display: inline-block; margin-bottom: 30px; }
    .pdf-container { display: flex; flex-direction: column; align-items: center; }
    .draggable { position: absolute; cursor: move; user-select: none; }
    .signature-pad { border: 1px solid #999; display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>محرر PDF يدعم العربية - نصوص، صور، توقيع</h2>

  <div class="controls">
    <input type="file" id="fileInput" accept="application/pdf">
    <input type="text" id="arabicText" placeholder="اكتب النص هنا">
    <select id="fontSize"><option>12</option><option>14</option><option selected>18</option><option>24</option><option>32</option></select>
    <input type="color" id="textColor" value="#d50000">
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="toggleSignature()">ارسم توقيعك</button>
    <button onclick="downloadPDF()">تحميل الملف النهائي</button>
  </div>

  <canvas id="signatureCanvas" class="signature-pad" width="300" height="150"></canvas>
  <button id="applySignature" style="display:none">إضافة التوقيع</button>

  <div id="pdfContainer" class="pdf-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    let pdfDoc, originalPdfDoc, canvases = [], texts = [], images = [], signatureDataUrl = null;
    const signatureCanvas = document.getElementById('signatureCanvas');
    const sigCtx = signatureCanvas.getContext('2d');
    let isDrawing = false;

    document.getElementById('fileInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function() {
        const uint8Array = new Uint8Array(this.result);
        pdfDoc = await PDFLib.PDFDocument.load(uint8Array);
        originalPdfDoc = await pdfjsLib.getDocument({ data: uint8Array }).promise;
        renderPages();
      };
      reader.readAsArrayBuffer(file);
    });

    async function renderPages() {
      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';
      canvases = [];

      for (let i = 1; i <= originalPdfDoc.numPages; i++) {
        const page = await originalPdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;

        const div = document.createElement('div');
        div.className = 'page-container';
        div.appendChild(canvas);
        document.getElementById('pdfContainer').appendChild(div);

        canvases.push({ canvas, container: div, pageIndex: i - 1 });

        canvas.addEventListener('click', function(e) {
          const x = e.offsetX, y = e.offsetY;
          const text = document.getElementById('arabicText').value;
          const fontSize = document.getElementById('fontSize').value;
          const color = document.getElementById('textColor').value;

          const divText = document.createElement('div');
          divText.className = 'draggable';
          divText.innerText = text;
          divText.style.left = x + 'px';
          divText.style.top = y + 'px';
          divText.style.fontSize = fontSize + 'px';
          divText.style.color = color;
          divText.contentEditable = true;
          makeDraggable(divText);
          div.appendChild(divText);
          texts.push({ pageIndex: i - 1, element: divText });
        });
      }
    }

    function makeDraggable(el) {
      let isDown = false, offsetX = 0, offsetY = 0;
      el.addEventListener('mousedown', e => {
        isDown = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });
      document.addEventListener('mousemove', e => {
        if (!isDown) return;
        el.style.left = (e.pageX - offsetX - el.parentElement.offsetLeft) + 'px';
        el.style.top = (e.pageY - offsetY - el.parentElement.offsetTop) + 'px';
      });
      document.addEventListener('mouseup', () => isDown = false);
    }

    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function() {
        const img = document.createElement('img');
        img.src = reader.result;
        img.className = 'draggable';
        img.style.width = '100px';
        img.style.top = '30px';
        img.style.left = '30px';
        img.style.position = 'absolute';
        img.setAttribute('draggable', false);
        img.addEventListener('wheel', e => {
          e.preventDefault();
          const size = parseInt(img.style.width);
          img.style.width = (size + (e.deltaY < 0 ? 10 : -10)) + 'px';
        });
        makeDraggable(img);
        canvases[0].container.appendChild(img);
        images.push({ pageIndex: 0, element: img, src: reader.result });
      };
      reader.readAsDataURL(file);
    });

    function toggleSignature() {
      signatureCanvas.style.display = 'block';
      document.getElementById('applySignature').style.display = 'inline-block';
      sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }

    signatureCanvas.addEventListener('mousedown', () => isDrawing = true);
    signatureCanvas.addEventListener('mouseup', () => {
      isDrawing = false;
      sigCtx.beginPath();
    });
    signatureCanvas.addEventListener('mousemove', e => {
      if (!isDrawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      sigCtx.lineWidth = 2;
      sigCtx.lineCap = 'round';
      sigCtx.strokeStyle = '#000';
      sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      sigCtx.stroke();
      sigCtx.beginPath();
      sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });

    document.getElementById('applySignature').addEventListener('click', () => {
      signatureDataUrl = signatureCanvas.toDataURL();
      const img = document.createElement('img');
      img.src = signatureDataUrl;
      img.className = 'draggable';
      img.style.width = '100px';
      img.style.top = '30px';
      img.style.left = '30px';
      makeDraggable(img);
      canvases[0].container.appendChild(img);
      images.push({ pageIndex: 0, element: img, src: signatureDataUrl });
      signatureCanvas.style.display = 'none';
      document.getElementById('applySignature').style.display = 'none';
    });

    async function downloadPDF() {
      const fontBytes = await fetch('https://pdf-lib.js.org/assets/fonts/Amiri-Regular.ttf').then(r => r.arrayBuffer());
      const font = await pdfDoc.embedFont(fontBytes);
      for (let { pageIndex, element } of texts) {
        const page = pdfDoc.getPages()[pageIndex];
        const x = parseInt(element.style.left), y = parseInt(element.style.top);
        const size = parseInt(element.style.fontSize);
        const color = hexToRgb(element.style.color);
        const text = element.innerText.split('').reverse().join('');
        page.drawText(text, {
          x: x,
          y: page.getHeight() - y - size,
          size: size,
          font,
          color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255),
        });
      }

      for (let { pageIndex, element, src } of images) {
        const imgBytes = await fetch(src).then(r => r.arrayBuffer());
        const imgEmbed = await pdfDoc.embedPng(imgBytes);
        const page = pdfDoc.getPages()[pageIndex];
        const x = parseInt(element.style.left), y = parseInt(element.style.top);
        const w = element.width, h = element.height;
        page.drawImage(imgEmbed, {
          x: x,
          y: page.getHeight() - y - h,
          width: w,
          height: h
        });
      }

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'ملف_نهائي.pdf';
      link.click();
    }

    function hexToRgb(hex) {
      const int = parseInt(hex.slice(1), 16);
      return { r: (int >> 16) & 255, g: (int >> 8) & 255, b: int & 255 };
    }
  </script>
</body>
</html>

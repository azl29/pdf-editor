
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر PDF مع دعم العربية والصور</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 20px;
      text-align: center;
      direction: rtl;
    }
    .pdf-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .page-container {
      position: relative;
      margin-bottom: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    .draggable-text, .draggable-img {
      position: absolute;
      cursor: move;
      user-select: none;
    }
    .controls {
      margin: 20px 0;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
    }
    img.preview {
      max-width: 100px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>محرر PDF متعدد الصفحات - مع دعم العربية وإدراج الصور</h2>

  <div class="controls">
    <input type="file" id="fileInput" accept="application/pdf">
    <input type="text" id="arabicText" placeholder="اكتب النص هنا">
    <label>الحجم</label>
    <select id="fontSize">
      <option value="12">12</option>
      <option value="14">14</option>
      <option value="18" selected>18</option>
      <option value="24">24</option>
      <option value="28">28</option>
      <option value="32">32</option>
    </select>
    <label>اللون</label>
    <input type="color" id="textColor" value="#d50000">
    <br>
    <label>أضف توقيع / صورة:</label>
    <input type="file" id="imageInput" accept="image/*">
    <br>
    <button onclick="downloadPDF()">تحميل الملف بعد التعديل</button>
  </div>

  <div id="pdfContainer" class="pdf-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    let pdfDoc, originalPdfDoc, canvases = [], texts = [], images = [];

    document.getElementById('fileInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function () {
        const uint8Array = new Uint8Array(this.result);
        pdfDoc = await PDFLib.PDFDocument.load(uint8Array);
        originalPdfDoc = await window['pdfjsLib'].getDocument({ data: uint8Array }).promise;
        renderPages();
      };
      reader.readAsArrayBuffer(file);
    });

    async function renderPages() {
      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';
      canvases = [];

      for (let i = 1; i <= originalPdfDoc.numPages; i++) {
        const page = await originalPdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 1.5 });

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;

        const pageDiv = document.createElement('div');
        pageDiv.className = 'page-container';
        pageDiv.style.width = canvas.width + 'px';
        pageDiv.style.height = canvas.height + 'px';

        pageDiv.appendChild(canvas);
        container.appendChild(pageDiv);

        canvases.push({ canvas, container: pageDiv, pageIndex: i - 1 });

        canvas.addEventListener('click', function (e) {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          insertText(pageDiv, x, y, i - 1);
        });

        pageDiv.addEventListener('dragover', e => e.preventDefault());
        pageDiv.addEventListener('drop', e => handleImageDrop(e, pageDiv, i - 1));
      }
    }

    function insertText(container, x, y, pageIndex) {
      const text = document.getElementById('arabicText').value;
      const fontSize = document.getElementById('fontSize').value;
      const color = document.getElementById('textColor').value;

      const div = document.createElement('div');
      div.className = 'draggable-text';
      div.innerText = text;
      div.contentEditable = true;
      div.style.fontSize = fontSize + 'px';
      div.style.color = color;
      div.style.left = x + 'px';
      div.style.top = y + 'px';

      makeDraggable(div);
      container.appendChild(div);

      texts.push({ pageIndex, element: div });
    }

    function makeDraggable(el) {
      let isDragging = false, offsetX = 0, offsetY = 0;
      el.addEventListener('mousedown', function (e) {
        isDragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        el.style.zIndex = 1000;
      });
      document.addEventListener('mousemove', function (e) {
        if (isDragging) {
          el.style.left = (e.pageX - offsetX - el.parentElement.offsetLeft) + 'px';
          el.style.top = (e.pageY - offsetY - el.parentElement.offsetTop) + 'px';
        }
      });
      document.addEventListener('mouseup', function () {
        isDragging = false;
      });
    }

    document.getElementById('imageInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        const img = document.createElement('img');
        img.src = reader.result;
        img.className = 'draggable-img';
        img.style.width = '100px';
        img.style.top = '20px';
        img.style.left = '20px';
        img.draggable = true;
        makeDraggable(img);
        canvases[0].container.appendChild(img);
        images.push({ pageIndex: 0, element: img, src: reader.result });
      };
      reader.readAsDataURL(file);
    });

    async function downloadPDF() {
      const fontUrl = 'https://pdf-lib.js.org/assets/fonts/Amiri-Regular.ttf';
      const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
      const customFont = await pdfDoc.embedFont(fontBytes, { subset: true });

      for (let { pageIndex, element } of texts) {
        const text = element.innerText.split('').reverse().join('');
        const x = parseInt(element.style.left);
        const y = parseInt(element.style.top);
        const size = parseInt(element.style.fontSize);
        const color = hexToRgb(element.style.color);
        const page = pdfDoc.getPages()[pageIndex];
        page.drawText(text, {
          x: x,
          y: page.getHeight() - y - size,
          size: size,
          font: customFont,
          color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255),
        });
      }

      for (let { pageIndex, element, src } of images) {
        const imgBytes = await fetch(src).then(res => res.arrayBuffer());
        const embeddedImg = await pdfDoc.embedPng(imgBytes);
        const page = pdfDoc.getPages()[pageIndex];
        const x = parseInt(element.style.left);
        const y = parseInt(element.style.top);
        const w = element.width;
        const h = element.height;
        page.drawImage(embeddedImg, {
          x: x,
          y: page.getHeight() - y - h,
          width: w,
          height: h,
        });
      }

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'ملف_بعد_التعديل.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
      };
    }
  </script>
</body>
</html>

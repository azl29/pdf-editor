<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر PDF متعدد الصفحات</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 20px;
      text-align: center;
    }
    .pdf-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 1px solid #ccc;
      margin: 10px 0;
      cursor: crosshair;
    }
    .controls {
      margin-top: 10px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>محرر PDF متعدد الصفحات</h2>
  <input type="file" id="pdfUpload" accept="application/pdf" />
  <div class="controls">
    <input type="text" id="textInput" placeholder="اكتب النص هنا" />
    <select id="fontSize">
      <option value="12">12px</option>
      <option value="14">14px</option>
      <option value="16">16px</option>
      <option value="20" selected>20px</option>
      <option value="24">24px</option>
      <option value="28">28px</option>
      <option value="32">32px</option>
    </select>
    <input type="color" id="textColor" value="#ff0000" />
    <button id="savePdf">حفظ PDF</button>
  </div>
  <div id="pdfContainer" class="pdf-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const pdfUpload = document.getElementById("pdfUpload");
    const textInput = document.getElementById("textInput");
    const fontSize = document.getElementById("fontSize");
    const textColor = document.getElementById("textColor");
    const pdfContainer = document.getElementById("pdfContainer");
    const savePdf = document.getElementById("savePdf");

    let pages = [];
    let draggingItem = null;
    let offsetX = 0, offsetY = 0;

    pdfUpload.addEventListener("change", async function(e) {
      pdfContainer.innerHTML = "";
      pages = [];
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function() {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.dataset.page = i;

          await page.render({ canvasContext: ctx, viewport }).promise;
          pdfContainer.appendChild(canvas);

          const items = [];

          canvas.addEventListener("click", function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const text = textInput.value;
            const size = fontSize.value;
            const color = textColor.value;
            ctx.font = `${size}px Cairo`;
            ctx.fillStyle = color;
            ctx.textAlign = "right";
            ctx.fillText(text, x, y);
            items.push({ text, x, y, size, color });
          });

          canvas.addEventListener("mousedown", function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const found = items.find(t => x >= t.x - 100 && x <= t.x + 100 && y >= t.y - 20 && y <= t.y + 20);
            if (found) {
              draggingItem = { canvas, item: found };
              offsetX = x - found.x;
              offsetY = y - found.y;
            }
          });

          canvas.addEventListener("mousemove", function(e) {
            if (draggingItem && draggingItem.canvas === canvas) {
              const rect = canvas.getBoundingClientRect();
              const x = e.clientX - rect.left;
              const y = e.clientY - rect.top;
              draggingItem.item.x = x - offsetX;
              draggingItem.item.y = y - offsetY;
              renderAll();
            }
          });

          canvas.addEventListener("mouseup", function() {
            draggingItem = null;
          });

          pages.push({ canvas, ctx, viewport, items });
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderAll() {
      pages.forEach(({ canvas, ctx, items }) => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        items.forEach(({ text, x, y, size, color }) => {
          ctx.font = `${size}px Cairo`;
          ctx.fillStyle = color;
          ctx.textAlign = "right";
          ctx.fillText(text, x, y);
        });
      });
    }

    savePdf.addEventListener("click", function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      pages.forEach((page, index) => {
        const imgData = page.canvas.toDataURL("image/jpeg");
        if (index > 0) doc.addPage();
        doc.addImage(imgData, "JPEG", 0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight());
      });
      doc.save("محرر.pdf");
    });
  </script>
</body>
</html>

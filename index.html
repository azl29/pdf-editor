<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر PDF بتعديل مباشر للنصوص</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 20px;
      text-align: center;
    }
    .pdf-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    canvas {
      border: 1px solid #ccc;
      margin: 10px 0;
    }
    .controls {
      margin-top: 10px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
    }
    .draggable-text {
      position: absolute;
      cursor: move;
      font-family: 'Cairo', sans-serif;
      user-select: none;
    }
  </style>
</head>
<body>
  <h2>محرر PDF متعدد الصفحات - بإمكانية سحب النصوص</h2>
  <input type="file" id="pdfUpload" accept="application/pdf" />
  <div class="controls">
    <input type="text" id="textInput" placeholder="اكتب النص هنا" />
    <select id="fontSize">
      <option value="12">12px</option>
      <option value="14">14px</option>
      <option value="16">16px</option>
      <option value="20" selected>20px</option>
      <option value="24">24px</option>
      <option value="28">28px</option>
      <option value="32">32px</option>
    </select>
    <input type="color" id="textColor" value="#ff0000" />
    <button id="savePdf">حفظ PDF</button>
  </div>
  <div id="pdfContainer" class="pdf-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const pdfUpload = document.getElementById("pdfUpload");
    const textInput = document.getElementById("textInput");
    const fontSize = document.getElementById("fontSize");
    const textColor = document.getElementById("textColor");
    const pdfContainer = document.getElementById("pdfContainer");
    const savePdf = document.getElementById("savePdf");

    let canvases = [];

    pdfUpload.addEventListener("change", async function(e) {
      pdfContainer.innerHTML = "";
      canvases = [];
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function() {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.dataset.page = i;
          pdfContainer.appendChild(canvas);

          await page.render({ canvasContext: ctx, viewport }).promise;
          canvases.push(canvas);

          canvas.addEventListener("click", function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const div = document.createElement("div");
            div.className = "draggable-text";
            div.contentEditable = true;
            div.innerText = textInput.value;
            div.style.left = `${canvas.offsetLeft + x}px`;
            div.style.top = `${canvas.offsetTop + y}px`;
            div.style.fontSize = fontSize.value + "px";
            div.style.color = textColor.value;
            pdfContainer.appendChild(div);

            makeDraggable(div);
          });
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function makeDraggable(el) {
      let isDragging = false;
      let offsetX, offsetY;
      el.addEventListener("mousedown", function(e) {
        isDragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        el.style.zIndex = 1000;
      });
      document.addEventListener("mousemove", function(e) {
        if (isDragging) {
          el.style.left = `${e.pageX - offsetX}px`;
          el.style.top = `${e.pageY - offsetY}px`;
        }
      });
      document.addEventListener("mouseup", function() {
        isDragging = false;
      });
    }

    savePdf.addEventListener("click", function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      canvases.forEach((canvas, index) => {
        const clone = canvas.cloneNode(true);
        const ctx = clone.getContext("2d");
        const divs = [...document.querySelectorAll('.draggable-text')].filter(d => {
          const top = parseInt(d.style.top);
          return top >= canvas.offsetTop && top <= canvas.offsetTop + canvas.height;
        });

        divs.forEach(d => {
          const text = d.innerText;
          const x = parseInt(d.style.left) - canvas.offsetLeft;
          const y = parseInt(d.style.top) - canvas.offsetTop + 10;
          ctx.font = `${d.style.fontSize} Cairo`;
          ctx.fillStyle = d.style.color;
          ctx.textAlign = "right";
          ctx.fillText(text, x, y);
        });

        const imgData = clone.toDataURL("image/jpeg");
        if (index > 0) doc.addPage();
        doc.addImage(imgData, "JPEG", 0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight());
      });

      doc.save("محرر.pdf");
    });
  </script>
</body>
</html>
